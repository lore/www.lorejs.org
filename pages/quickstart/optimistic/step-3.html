---
layout: quickstart
permalink: /quickstart/optimistic/step-3/
---

{% capture markdown %}

# Step 3: Show Optimistic Visual Cues

In this step we'll add an opacity effect to tweets to reflect when they're being created, updated or deleted.

> You can view the finished code for this step by checking out the `optimistic.3` branch of the [completed project](/quickstart/misc/completed-project/).

### Problem: Error When Creating Tweets
If you try to create a tweet, if may look like the application behaves correctly, but if you look in the console
you'll see the following error:

```
Invalid call to `getState('user.byId')`. Missing required attribute `id`.
```

This happens because the call to create a tweet in the `CreateButton` component looks like this:

```js
lore.actions.tweet.create(params);
```

At the point this action is called, `params` only contains the parameter `{"text": "Some tweet text"}`, but our
application immediately tries to render the Tweet (because Lore defaults to optimistic behavior). But the error we
see is generated by the `Tweet` component which has a `lore.connect` call that look like this:

```js
lore.connect(function(getState, props){
  var tweet = props.tweet;

  return {
    user: getState('user.byId', {
      id: tweet.data.user
    })
  };
})
```

When this method tries to render our optimistic tweet, there *is not user field* on the `tweet` we just created, so
we get this error because the `getState` call can't locate a tweet with an undefined id.


### Set Optimistic Data for New Tweets
To fix this, we *could* add logic to our component to behave differently when no `user` field exists (like showing
an unknown avatar photo or changing the timestamp message to something like 'saving...'), but in this
case we're going to do something much simpler, and simply provide the `user` and `createdAt` fields ourselves when we
create the tweet. We already know what those fields will be anyway, so in this case, we can simply set them ourselves
on the optimistic data to get the experience we want.

To fix this problem, update the `onClick` method of the `CreateButton` component to look like this:

```jsx
onClick: function() {
  var user = this.context.user;

  function createTweet(params) {
    lore.actions.tweet.create(_.extend(params, {
      user: user.id,
      createdAt: new Date().toISOString()
    }));
  }

  lore.dialog.show(function() {
    return lore.dialogs.tweet.create({
      onSubmit: createTweet
    });
  });
}
```

### Add Visual Cue for Optimistic Changes
The change above solves our issue, but we're not providing the user with any feedback that a change is occuring,
and even worse, we're exposing functionality that doesn't exist yet when tweets are being created.

To improve the experience, we're going to visually fade the tweet when it's being created, updated or deleted, and
we're not going to show the `edit` or `delete` button until we have confirmation that the tweet actually exists (since
we can't update or delete data that we don't know the id for).

Update the `render` method of the `Tweet` component to look like this:

```jsx
render: function() {
  var tweet = this.props.tweet;
  var user = this.props.user;
  var timestamp = moment(tweet.data.createdAt).fromNow().split(' ago')[0];
  var isOptimistic = (
    tweet.state === PayloadStates.CREATING ||
    tweet.state === PayloadStates.UPDATING ||
    tweet.state === PayloadStates.DELETING
  );

  return (
    <li className={"list-group-item tweet" + (isOptimistic ? " optimistic" : "")}>
      <div className="image-container">
        <img
          className="img-circle avatar"
          src={user.data.avatar} />
      </div>
      <div className="content-container">
        <h4 className="list-group-item-heading title">
          {user.data.nickname}
        </h4>
        <h4 className="list-group-item-heading timestamp">
          {'- ' + timestamp}
        </h4>
        <p className="list-group-item-text text">
          {tweet.data.text}
        </p>
        <div className="tweet-actions">
          <EditLink tweet={tweet} />
          <DeleteLink tweet={tweet} />
        </div>
      </div>
    </li>
  );
}
```

Now tweets will only show the `edit` and `delete` links once the server confirms they exist, and any modifications to
a tweet will show a visual cue to the user. That's a much better experience.


### Visual Check-in

If everything went well, your application should now look like this.

<img class="drop-shadow" src="/assets/images/quickstart/filtering/step-1.png">


## Code Changes

Below is a list of files modified during this step.

### src/components/CreateButton.js

{% tabs tab1={"name": "ES5", "id": 1} | tab3={"name": "ES6", "id": 2} | tab4={"name": "ESNext", "id": 3} %}
{% tab id=1, is_active=true %}
```jsx
var React = require('react');
var _ = require('lodash');

module.exports = React.createClass({
  displayName: 'CreateButton',

  contextTypes: {
    user: React.PropTypes.object.isRequired
  },

  onClick: function() {
    var user = this.context.user;

    function createTweet(params) {
      lore.actions.tweet.create(_.extend(params, {
        user: user.id,
        createdAt: new Date().toISOString()
      }));
    }

    lore.dialog.show(function() {
      return lore.dialogs.tweet.create({
        onSubmit: createTweet
      });
    });
  },

  render: function() {
    return (
      <button
        type="button"
        className="btn btn-primary btn-lg create-button"
        onClick={this.onClick}>
        +
      </button>
    );
  }

});
```
{% endtab %}
{% tab id=2 %}
```jsx
// PASTE_HERE
```
{% endtab %}
{% tab id=3 %}
```jsx
// PASTE_HERE
```
{% endtab %}
{% endtabs %}

### src/components/Tweet.js

{% tabs tab1={"name": "ES5", "id": 4} | tab2={"name": "ES6", "id": 5} | tab3={"name": "ESNext", "id": 6} %}
{% tab id=4, is_active=true %}
```jsx
var React = require('react');
var moment = require('moment');
var EditLink = require('./EditLink');
var DeleteLink = require('./DeleteLink');
var PayloadStates = require('../constants/PayloadStates');

module.exports = lore.connect(function(getState, props){
  var tweet = props.tweet;

  return {
    user: getState('user.byId', {
      id: tweet.data.user
    })
  };
})(
React.createClass({
  displayName: 'Tweet',

  propTypes: {
    tweet: React.PropTypes.object.isRequired,
    user: React.PropTypes.object.isRequired
  },

  render: function() {
    var tweet = this.props.tweet;
    var user = this.props.user;
    var timestamp = moment(tweet.data.createdAt).fromNow().split(' ago')[0];
    var isOptimistic = (
      tweet.state === PayloadStates.CREATING ||
      tweet.state === PayloadStates.UPDATING ||
      tweet.state === PayloadStates.DELETING
    );

    return (
      <li className={"list-group-item tweet" + (isOptimistic ? " optimistic" : "")}>
        <div className="image-container">
          <img
            className="img-circle avatar"
            src={user.data.avatar} />
        </div>
        <div className="content-container">
          <h4 className="list-group-item-heading title">
            {user.data.nickname}
          </h4>
          <h4 className="list-group-item-heading timestamp">
            {'- ' + timestamp}
          </h4>
          <p className="list-group-item-text text">
            {tweet.data.text}
          </p>
          <div className="tweet-actions">
            <EditLink tweet={tweet} />
            <DeleteLink tweet={tweet} />
          </div>
        </div>
  </li>
  );
  }

})
);
```
{% endtab %}
{% tab id=5 %}
```jsx
// PASTE_HERE
```
{% endtab %}
{% tab id=6 %}
```jsx
// PASTE_HERE
```
{% endtab %}
{% endtabs %}


## Next Steps

In the next section [we'll add support for WebSockets](../../websockets/overview/).

{% endcapture %}
{{ markdown | markdownify }}
