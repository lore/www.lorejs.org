---
layout: quickstart
permalink: /quickstart/optimistic/step-2/
---

{% capture markdown %}

# Step 2: Display New Tweets

In this step we'll display new tweets at the top of the Feed.

> You can view the finished code for this step by checking out the `optimistic.2` branch of the [completed project](/quickstart/misc/completed-project/).

### Problem: New Tweets Do Not Appear

Ever since we introduced pagination, new tweets stopped showing up in the Feed when you create them. This certainly
doesn't match the expected user experience. The reason for this is that the application doesn't know what to do with
the new tweets you create. What the application is displaying is exactly what you asked for; the first page of tweets.

To solve this, we're going to use a different `lore.connect` mapping called `tweet.all`, which when can use to filter
and sort the existing tweet, and only extract the new ones.

### Get New Tweets
Update the `lore.connect` call in the `Feed` component to use the `tweet.all` mapping. This function has two optional
parameters. By default, it returns *all* tweets, but you can pass in an optional filter method using the  `where`
paramter, as well as an optional sorting criteria using the `sortBy` parameter.

{% tabs tab1={"name": "ES5", "id": 101} | tab2={"name": "ES6", "id": 102} | tab3={"name": "ESNext", "id": 103} %}
{% tab id=101, is_active=true %}
```jsx
var moment = require('moment');

module.exports = lore.connect(function(getState, props){
  return {
    newTweets: getState('tweet.all', {
      where: function(tweet) {
        return !tweet.id || moment(tweet.data.createdAt).diff(lore.timestamp) > 0
      },
      sortBy: function(tweet) {
        return -moment(tweet.data.createdAt).unix();
      }
    }),
    tweets: getState('tweet.find', {
      where: {
        where: {
          createdAt: {
            '<=': lore.timestamp
          }
        }
      },
      pagination: {
        sort: 'createdAt DESC',
        page: props.location.query.page || '1',
        populate: 'user'
      }
    })
  }
})
```
{% endtab %}
{% tab id=102 %}
```jsx
import moment from 'moment';

lore.connect(function(getState, props){
  return {
    newTweets: getState('tweet.all', {
      where: function(tweet) {
        return !tweet.id || moment(tweet.data.createdAt).diff(lore.timestamp) > 0
      },
      sortBy: function(tweet) {
        return -moment(tweet.data.createdAt).unix();
      }
    }),
    tweets: getState('tweet.find', {
      where: {
        where: {
          createdAt: {
            '<=': lore.timestamp
          }
        }
      },
      pagination: {
        sort: 'createdAt DESC',
        page: props.location.query.page || '1',
        populate: 'user'
      }
    })
  }
})
```
{% endtab %}
{% tab id=103 %}
```jsx
import moment from 'moment';

@lore.connect(function(getState, props){
  return {
    newTweets: getState('tweet.all', {
      where: function(tweet) {
        return !tweet.id || moment(tweet.data.createdAt).diff(lore.timestamp) > 0
      },
      sortBy: function(tweet) {
        return -moment(tweet.data.createdAt).unix();
      }
    }),
    tweets: getState('tweet.find', {
      where: {
        where: {
          createdAt: {
            '<=': lore.timestamp
          }
        }
      },
      pagination: {
        sort: 'createdAt DESC',
        page: props.location.query.page || '1',
        populate: 'user'
      }
    })
  }
})
```
{% endtab %}
{% endtabs %}

### Display New Tweets
Next, update the `Feed` component itself to render the new tweets above the paginated results.

{% tabs tab1={"name": "ES5", "id": 104} | tab2={"name": "ES6", "id": 105} | tab3={"name": "ESNext", "id": 106} %}
{% tab id=104, is_active=true %}
```jsx
React.createClass({
  // ...

  propTypes: {
    newTweets: React.PropTypes.object.isRequired,
    // ...
  },

  // ...

  render: function() {
    // ...
    var newTweets = this.props.newTweets.data.map(this.renderTweet);

    return (
      <div className="feed">
        <h2 className="title">
          Feed
        </h2>
        <ul className="media-list tweets">
          {newTweets}
          {tweetListItems}
        </ul>
        <LoadMoreButton
          lastPage={lastPage}
          onLoadMore={this.props.onLoadMore}
          nextPageMetaField="nextPage" />
      </div>
    );
  }

})
```
{% endtab %}
{% tab id=105 %}
```jsx
class Feed extends React.Component {
  // ...

  render: function() {
    // ...
    const newTweets = this.props.newTweets.data.map(this.renderTweet);

    return (
      <div className="feed">
        <h2 className="title">
          Feed
        </h2>
        <ul className="media-list tweets">
          {newTweets}
          {tweetListItems}
        </ul>
        <LoadMoreButton
          lastPage={lastPage}
          onLoadMore={this.props.onLoadMore}
          nextPageMetaField="nextPage" />
      </div>
    );
  }

}

Feed.propTypes = {
  newTweets: React.PropTypes.object.isRequired,
  // ...
};
```
{% endtab %}
{% tab id=106 %}
```jsx
class Feed extends React.Component {
  // ...

  static propTypes = {
    newTweets: React.PropTypes.object.isRequired,
    // ...
  };

  // ...

  render() {
    // ...
    const newTweets = this.props.newTweets.data.map(this.renderTweet);

    return (
      <div className="feed">
        <h2 className="title">
          Feed
        </h2>
        <ul className="media-list tweets">
          {newTweets}
          {tweetListItems}
        </ul>
        <LoadMoreButton
          lastPage={lastPage}
          onLoadMore={this.props.onLoadMore}
          nextPageMetaField="nextPage" />
      </div>
    );
  }

}
```
{% endtab %}
{% endtabs %}

Now when you create new tweets, they'll show up at the top of the Feed.

### Repeat for the UserTweets Component
Now make the same changes to the `UserTweets` component:

{% tabs tab1={"name": "ES5", "id": 107} | tab2={"name": "ES6", "id": 108} | tab3={"name": "ESNext", "id": 109} %}
{% tab id=107, is_active=true %}
```jsx
// ...
var moment = require('moment');

module.exports = lore.connect(function(getState, props){
  return {
    newTweets: getState('tweet.all', {
      where: function(tweet) {
        return (
          tweet.data.user === Number(props.params.userId) &&
          !tweet.id || moment(tweet.data.createdAt).diff(lore.timestamp) > 0
        )
      },
      sortBy: function(tweet) {
        return -moment(tweet.data.createdAt).unix();
      }
    }),
    tweets: getState('tweet.find', {
      // ...
    })
  }
})(
InfiniteScrolling({ propName: 'tweets', modelName: 'tweet' })(
React.createClass({
  // ...

  propTypes: {
    newTweets: React.PropTypes.object.isRequired,
    // ...
  },

  // ...

  render: function() {
    // ...

    var newTweets = this.props.newTweets.data.map(this.renderTweet);

    return (
      <div className="feed">
        <h2 className="title">
          My Tweets
        </h2>
        <ul className="media-list tweets">
          {newTweets}
          {tweetListItems}
        </ul>
        <LoadMoreButton
          lastPage={lastPage}
          onLoadMore={this.props.onLoadMore}
          nextPageMetaField="nextPage" />
      </div>
    );
  }

})
)
);
```
{% endtab %}
{% tab id=108 %}
```jsx
// PASTE_HERE
```
{% endtab %}
{% tab id=109 %}
```jsx
// PASTE_HERE
```
{% endtab %}
{% endtabs %}

With that change in place, new tweets will show up in both the `Feed` and `UserTweets` components, regardless of which
page you create the tweet on.


### Visual Check-in

If everything went well, your application should now look like this.

<img class="drop-shadow" src="/assets/images/quickstart/filtering/step-1.png">


## Code Changes

Below is a list of files modified during this step.

### src/components/Feed.js

{% tabs tab1={"name": "ES5", "id": 1} | tab3={"name": "ES6", "id": 2} | tab4={"name": "ESNext", "id": 3} %}
{% tab id=1, is_active=true %}
```jsx
var React = require('react');
var Tweet = require('./Tweet');
var PayloadStates = require('../constants/PayloadStates');
var InfiniteScrolling = require('../decorators/InfiniteScrolling');
var LoadMoreButton = require('./LoadMoreButton');
var moment = require('moment');

module.exports = lore.connect(function(getState, props){
  return {
    newTweets: getState('tweet.all', {
      where: function(tweet) {
        return !tweet.id || moment(tweet.data.createdAt).diff(lore.timestamp) > 0
      },
      sortBy: function(tweet) {
        return -moment(tweet.data.createdAt).unix();
      }
    }),
    tweets: getState('tweet.find', {
      where: {
        where: {
          createdAt: {
            '<=': lore.timestamp
          }
        }
      },
      pagination: {
        sort: 'createdAt DESC',
        page: props.location.query.page || '1',
        populate: 'user'
      }
    })
  }
})(
InfiniteScrolling({ propName: 'tweets', modelName: 'tweet' })(
React.createClass({
  displayName: 'Feed',

  propTypes: {
    newTweets: React.PropTypes.object.isRequired,
    pages: React.PropTypes.array.isRequired,
    onLoadMore: React.PropTypes.func.isRequired
  },

  renderTweet: function(tweet) {
    return (
      <Tweet key={tweet.id || tweet.cid} tweet={tweet} />
    );
  },

  render: function() {
    var pages = this.props.pages;
    var numberOfPages = pages.length;
    var firstPage = pages[0];
    var lastPage = pages[pages.length - 1];

    if (numberOfPages === 1 && lastPage.state === PayloadStates.FETCHING) {
      return (
        <h1 className="loading-text">
          Loading...
        </h1>
      );
    }

    var newTweets = this.props.newTweets.data.map(this.renderTweet);

    var tweetListItems = _.flatten(pages.map(function(tweets) {
      return tweets.data.map(this.renderTweet);
    }.bind(this)));

    return (
      <div className="feed">
        <h2 className="title">
          Feed
        </h2>
        <ul className="media-list tweets">
          {newTweets}
          {tweetListItems}
        </ul>
        <LoadMoreButton
          lastPage={lastPage}
          onLoadMore={this.props.onLoadMore}
          nextPageMetaField="nextPage" />
      </div>
    );
  }

})
)
);
```
{% endtab %}
{% tab id=2 %}
```jsx
// PASTE_HERE
```
{% endtab %}
{% tab id=3 %}
```jsx
// PASTE_HERE
```
{% endtab %}
{% endtabs %}

### src/components/UserTweets.js

{% tabs tab1={"name": "ES5", "id": 4} | tab2={"name": "ES6", "id": 5} | tab3={"name": "ESNext", "id": 6} %}
{% tab id=4, is_active=true %}
```jsx
var React = require('react');
var Tweet = require('./Tweet');
var PayloadStates = require('../constants/PayloadStates');
var InfiniteScrolling = require('../decorators/InfiniteScrolling');
var LoadMoreButton = require('./LoadMoreButton');
var moment = require('moment');

module.exports = lore.connect(function(getState, props){
  return {
    newTweets: getState('tweet.all', {
      where: function(tweet) {
        return (
          tweet.data.user === Number(props.params.userId) &&
          !tweet.id || moment(tweet.data.createdAt).diff(lore.timestamp) > 0
        )
      },
      sortBy: function(tweet) {
        return -moment(tweet.data.createdAt).unix();
      }
    }),
    tweets: getState('tweet.find', {
      where: {
        where: {
          user: props.params.userId,
          createdAt: {
            '<=': lore.timestamp
          }
        }
      },
      pagination: {
        sort: 'createdAt DESC',
        page: '1'
      }
    })
  }
})(
InfiniteScrolling({ propName: 'tweets', modelName: 'tweet' })(
React.createClass({
  displayName: 'UserTweets',

  propTypes: {
    newTweets: React.PropTypes.object.isRequired,
    pages: React.PropTypes.array.isRequired,
    onLoadMore: React.PropTypes.func.isRequired
  },

  renderTweet: function(tweet) {
    return (
      <Tweet key={tweet.id || tweet.cid} tweet={tweet} />
    );
  },

  render: function() {
    var pages = this.props.pages;
    var numberOfPages = pages.length;
    var firstPage = pages[0];
    var lastPage = pages[pages.length - 1];

    if (numberOfPages === 1 && lastPage.state === PayloadStates.FETCHING) {
      return (
        <h1 className="loading-text">
          Loading...
        </h1>
      );
    }

    var newTweets = this.props.newTweets.data.map(this.renderTweet);

    var tweetListItems = _.flatten(pages.map(function(tweets) {
      return tweets.data.map(this.renderTweet);
    }.bind(this)));

    return (
      <div className="feed">
        <h2 className="title">
          My Tweets
        </h2>
        <ul className="media-list tweets">
          {newTweets}
          {tweetListItems}
        </ul>
        <LoadMoreButton
          lastPage={lastPage}
          onLoadMore={this.props.onLoadMore}
          nextPageMetaField="nextPage" />
      </div>
    );
  }

})
)
);
```
{% endtab %}
{% tab id=5 %}
```jsx
// PASTE_HERE
```
{% endtab %}
{% tab id=6 %}
```jsx
// PASTE_HERE
```
{% endtab %}
{% endtabs %}


## Next Steps

In the next section we'll add a [visual cue when tweets are being created, updated or deleted](../step-3/).

{% endcapture %}
{{ markdown | markdownify }}
